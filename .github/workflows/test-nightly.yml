name: Govbot Nightly Synthetic Test

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/test-nightly.yml'

jobs:
  synthetic-test:
    name: Synthetic Real-World Test
    runs-on: ubuntu-latest
    steps:
      - name: Install govbot via install script
        run: |
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/windy-civi/toolkit/main/actions/govbot/scripts/install-nightly.sh)"
          # Add to PATH for subsequent steps
          echo "${HOME}/.govbot/bin" >> $GITHUB_PATH

      - name: Verify govbot installation
        run: |
          govbot --version
          govbot --help

      - name: Run govbot clone all
        id: clone
        run: |
          # Clone all repositories
          govbot clone all --verbose

          # Verify at least one repository was cloned
          REPO_COUNT=$(ls -1 "${HOME}/.govbot/repos" 2>/dev/null | wc -l)
          if [ "$REPO_COUNT" -eq 0 ]; then
            echo "::error::govbot clone all failed - no repositories were cloned"
            exit 1
          fi

          echo "Clone completed successfully - $REPO_COUNT repositories"

      - name: Run govbot logs and validate output
        id: logs
        run: |
          # Capture logs output
          OUTPUT=$(govbot logs --limit 10 2>&1) || {
            echo "::error::govbot logs command failed with exit code $?"
            echo "Output: $OUTPUT"
            exit 1
          }

          # Check for empty output
          if [ -z "$OUTPUT" ]; then
            echo "::error::govbot logs produced empty output"
            exit 1
          fi

          # Count number of log entries (each line should be valid JSON)
          LINE_COUNT=$(echo "$OUTPUT" | wc -l)
          echo "Log entries retrieved: $LINE_COUNT"

          if [ "$LINE_COUNT" -eq 0 ]; then
            echo "::error::govbot logs produced zero entries"
            exit 1
          fi

          # Validate that output is valid JSON Lines format
          echo "$OUTPUT" | while read -r line; do
            if [ -n "$line" ]; then
              echo "$line" | jq . > /dev/null 2>&1 || {
                echo "::error::Invalid JSON in govbot logs output"
                echo "Invalid line: $line"
                exit 1
              }
            fi
          done

          echo "Logs validation completed successfully"
          echo "Sample output (first 3 lines):"
          echo "$OUTPUT" | head -3

      - name: Summary
        if: always()
        run: |
          echo "## Govbot Nightly Synthetic Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Install | ${{ steps.clone.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clone | ${{ steps.clone.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Logs | ${{ steps.logs.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
