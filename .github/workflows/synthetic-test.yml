name: Nightly Real World End To End Test

on:
  schedule:
    - cron: '0 6 * * *' # 6 AM UTC daily
  workflow_run:
    workflows: ["Govbot Nightly"]
    types: [completed]
    branches: [main]
  pull_request:
    paths:
      - .github/workflows/synthetic-test.yml
      - actions/govbot/tapes/nightly/synthetic-test.tape
  workflow_dispatch:

jobs:
  synthetic-test:
    name: Govbot Wizard & Clone
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
    if: >-
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || '' }}

      - name: Install govbot nightly
        run: |
          curl -fsSL "https://github.com/windy-civi/toolkit/releases/download/nightly/govbot-linux-x86_64" -o govbot
          chmod +x govbot
          sudo mv govbot /usr/local/bin/
          govbot --help

      - name: Install VHS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          TTYD_VERSION="1.7.7"
          curl -fsSL "https://github.com/tsl0922/ttyd/releases/download/${TTYD_VERSION}/ttyd.x86_64" -o ttyd
          chmod +x ttyd
          sudo mv ttyd /usr/local/bin/

      - name: Install VHS
        run: |
          VHS_VERSION="0.8.0"
          curl -fsSL "https://github.com/charmbracelet/vhs/releases/download/v${VHS_VERSION}/vhs_${VHS_VERSION}_amd64.deb" -o vhs.deb
          sudo dpkg -i vhs.deb
          rm vhs.deb

      - name: Run end-to-end test (with retry)
        run: |
          run_test() {
            rm -rf /tmp/govbot-test /tmp/govbot-synthetic-test.gif
            vhs actions/govbot/tapes/nightly/synthetic-test.tape
            echo "=== govbot.yml ==="
            cat /tmp/govbot-test/govbot.yml
            echo ""
            echo "=== Cloned repos ==="
            ls -la /tmp/govbot-test/.govbot/repos/
            test -d /tmp/govbot-test/.govbot/repos/
          }

          if run_test; then
            echo "E2E test passed on attempt 1"
          else
            echo "::warning::Attempt 1 failed, retrying..."
            sleep 10
            if run_test; then
              echo "E2E test passed on attempt 2"
            else
              echo "::error::E2E test failed after 2 attempts"
              exit 1
            fi
          fi

      - name: Commit recording to PR branch
        id: commit-gif
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ ! -f /tmp/govbot-synthetic-test.gif ]; then
            echo "gif_url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          cp /tmp/govbot-synthetic-test.gif actions/govbot/tapes/nightly/synthetic-test.gif
          git add actions/govbot/tapes/nightly/synthetic-test.gif --force
          if git diff --cached --quiet; then
            echo "No GIF changes"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update synthetic test recording [skip ci]"
            git push
          fi
          SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "gif_url=https://raw.githubusercontent.com/${{ github.repository }}/${SHA}/actions/govbot/tapes/nightly/synthetic-test.gif" >> $GITHUB_OUTPUT

      - name: Job summary
        if: always()
        run: |
          echo "## Nightly Real World End To End Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          GIF_URL="${{ steps.commit-gif.outputs.gif_url }}"
          if [ -n "$GIF_URL" ]; then
            echo "### Recording" >> $GITHUB_STEP_SUMMARY
            echo "![E2E Test Recording]($GIF_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f /tmp/govbot-test/govbot.yml ]; then
            echo "### govbot.yml" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            cat /tmp/govbot-test/govbot.yml >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> govbot.yml was not generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cloned repos" >> $GITHUB_STEP_SUMMARY
          if [ -d /tmp/govbot-test/.govbot/repos ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls /tmp/govbot-test/.govbot/repos/ >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "> No repos were cloned" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post PR comment with recording
        if: always() && github.event_name == 'pull_request' && steps.commit-gif.outputs.gif_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const gifUrl = '${{ steps.commit-gif.outputs.gif_url }}';
            const sha = '${{ steps.commit-gif.outputs.sha }}';

            let body = `## Nightly Real World End To End Test Recording\n\n`;
            body += `> Auto-generated at ${sha.slice(0, 7)}\n\n`;
            body += `![E2E Test](${gifUrl})\n`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## Nightly Real World End To End Test Recording';
            const existing = comments.find(c => c.body && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Upload recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: synthetic-test-recording
          path: /tmp/govbot-synthetic-test.gif
          retention-days: 7
