name: Terminal Screenshots

on:
  pull_request:
    paths:
      - "actions/govbot/src/**"
      - "actions/govbot/tapes/*.tape"
      - "actions/govbot/Cargo.toml"
      - "actions/govbot/Cargo.lock"
      - ".github/workflows/terminal-screenshots.yml"

jobs:
  terminal-screenshots:
    name: Generate Terminal GIFs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            actions/govbot/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build govbot
        run: |
          cd actions/govbot
          cargo build --release
          echo "$PWD/target/release" >> $GITHUB_PATH

      - name: Install VHS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install VHS
        run: |
          VHS_VERSION="0.8.0"
          curl -fsSL "https://github.com/charmbracelet/vhs/releases/download/v${VHS_VERSION}/vhs_${VHS_VERSION}_amd64.deb" -o vhs.deb
          sudo dpkg -i vhs.deb
          rm vhs.deb
          vhs --version

      - name: Record terminal GIFs
        run: |
          cd actions/govbot
          for tape in tapes/*.tape; do
            [ -f "$tape" ] || continue
            echo "::group::Recording $tape"
            vhs "$tape"
            echo "::endgroup::"
          done

      - name: Commit GIFs to PR branch
        id: commit-gifs
        run: |
          cd actions/govbot
          git add tapes/*.gif --force
          if git diff --cached --quiet; then
            echo "No GIF changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update terminal screenshot GIFs [skip ci]"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Upload GIFs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terminal-screenshots
          path: actions/govbot/tapes/*.gif
          retention-days: 30

      - name: Post PR comment with inline GIFs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const tapesDir = 'actions/govbot/tapes';
            const gifs = fs.readdirSync(tapesDir).filter(f => f.endsWith('.gif')).sort();

            if (gifs.length === 0) {
              console.log('No GIFs found, skipping comment');
              return;
            }

            const sha = '${{ steps.commit-gifs.outputs.sha }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let body = `## Terminal Screenshots\n\n`;
            body += `> Auto-generated from \`actions/govbot/tapes/*.tape\` at ${sha.slice(0, 7)}\n\n`;

            for (const gif of gifs) {
              const name = path.basename(gif, '.gif');
              const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${sha}/actions/govbot/tapes/${gif}`;
              body += `### \`${name}\`\n\n`;
              body += `![${name}](${rawUrl})\n\n`;
            }

            // Find existing comment to update (avoids duplicate comments on re-runs)
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: context.issue.number,
            });

            const marker = '## Terminal Screenshots';
            const existing = comments.find(c => c.body && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              console.log(`Updated existing comment ${existing.id}`);
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body,
              });
              console.log('Created new comment');
            }
