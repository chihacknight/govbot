# Testing Strategy

This document describes how testing works across the govbot monorepo.

## Data Lineage & Mock Dependencies

```
UPSTREAM PIPELINE (produces git repos)
┌─────────┐    ┌──────────┐    ┌───────────┐    ┌──────────────────┐
│  scrape  │ →  │  format   │ →  │  extract  │ →  │  git repos       │
│          │    │           │    │           │    │  (wy-legislation) │
└─────────┘    └──────────┘    └───────────┘    └──────────────────┘
     │               │                                    │
  scrape/            format/snapshots/                    │
  prod-mocks         (tested via render_snapshot.sh       │
                      + schema validation)                │
                                                          │
═══════════════ GIT REPO STRUCTURE IS THE CONTRACT ═══════════════
                                                          │
                        govbot/mocks/.govbot/repos/       │
                        (captured from real repos          │
                         via `just mocks`)                 │
                              │                            │
                    ┌─────────────────────────────────┐   │
                    │  govbot clone → logs → tag → build  │
                    └─────────────────────────────────┘

Mock data sources:
  • scrape/prod-mocks-*     → captured from real scrape runs → fed to format tests
  • govbot/mocks/.govbot/   → captured from real published repos → fed to govbot tests
  • format/snapshots/wy/    → generated by running format on scrape mocks
```

## Testing Tiers

```
Tier 3: Nightly Visual E2E      VHS tapes in prod mode (live data, smoke assertions)
   │                             GIF uploaded to releases for visual review
   │
Tier 2: PR Visual Integration   VHS tapes in mock mode (deterministic, snapshot assertions)
   │                             GIF uploaded as PR artifact
   │
Tier 1: Schema Contracts         JSON Schema validation of mock data + format output
   │                             Catches interface breakage between pipeline stages
   │
Tier 0: Unit Tests               Wizard round-trip tests, pure logic (keep in Rust/insta)
                                  No I/O, no VHS needed
```

## Dual-Mode VHS Testing

Every VHS tape runs in two modes controlled by environment variables:

| Mode | When | Data Source | Assertion Level |
|------|------|-------------|-----------------|
| **Mock** (`TEST_MODE=mock`) | PR (fast) | Pre-populated from `mocks/` | Snapshot diff (byte-exact match against committed expected files) |
| **Prod** (`TEST_MODE=prod`) | Nightly | Live cloned repos | Smoke test (exit code 0, non-empty output) |

### Environment Variables

- `TEST_MODE` — `mock` or `prod` (default: `prod`)
- `GOVBOT_DIR` — Path to `.govbot` directory containing repos (default: `mocks/.govbot` for demo tapes)

### How Assertions Work

Each tape defines a short helper function `sk()` (snapshot check) and uses `Wait+Screen`
to assert VHS sees `SNAP_OK` on screen:

```tape
# Define assertion helper at tape start
Type "sk() { if [ ${TEST_MODE:-prod} = mock ]; then diff $1 $2 && echo SNAP_OK || echo SNAP_FAIL; else [ -s $1 ] && echo SNAP_OK || echo SNAP_FAIL; fi; }"
Enter

# Run command, capture output to temp file, display it
Type "govbot logs --govbot-dir mocks/.govbot > /tmp/lb.txt 2>&1 && cat /tmp/lb.txt"
Enter
Sleep 3s

# Clear screen so assertion output is visible
Type "clear"
Enter

# Assert: mock mode diffs against expected file, prod mode checks non-empty
Type "sk /tmp/lb.txt tapes/expected/logs-basic.txt"
Enter
Wait+Screen@5s /SNAP_OK/
```

## Per-Action Test Inventory

### govbot (Rust CLI)

| Test | Type | Location | Mode |
|------|------|----------|------|
| Wizard round-trip | Rust unit test (insta) | `tests/wizard_tests.rs` | `cargo test` |
| `govbot --help` | VHS tape | `tapes/govbot-help.tape` | mock/prod |
| `govbot clone --list` | VHS tape | `tapes/govbot-clone-list.tape` | mock/prod |
| `govbot logs` | VHS tape | `tapes/logs-basic.tape` | mock/prod |
| Full pipeline E2E | VHS tape | `tapes/nightly/synthetic-test.tape` | mock/prod |

### format (Python)

| Test | Type | Location |
|------|------|----------|
| Schema validation | JSON Schema | `validate-snapshots.yml` → format-snapshots job |
| Snapshot comparison | `render-snapshots.sh` | `validate-snapshots.yml` → format-snapshots job |

### pipeline-manager / report-publisher

| Test | Type | Location |
|------|------|----------|
| Snapshot comparison | `render-snapshots.sh` | `validate-snapshots.yml` |

## Running Tests Locally

### Rust unit tests (Tier 0)

```bash
cd actions/govbot
just test              # Run all tests
just test-single wizard_tests  # Run specific test
just review            # Review snapshot changes (insta)
```

### VHS demo tapes in mock mode (Tier 2)

```bash
cd actions/govbot

# Build binary first
just build-release

# Record all demo tapes
TEST_MODE=mock just record

# Record a specific tape
TEST_MODE=mock just record govbot-help
```

### VHS synthetic test in mock mode (Tier 2)

```bash
cd actions/govbot
export PATH="$PWD/target/release:$PATH"
TEST_MODE=mock GOVBOT_SRC="$PWD" vhs tapes/nightly/synthetic-test.tape
```

### VHS tapes in prod mode (Tier 3)

```bash
cd actions/govbot
export PATH="$PWD/target/release:$PATH"
# Requires network access — clones real repos
vhs tapes/nightly/synthetic-test.tape
```

## Updating Mocks

When upstream data format changes, refresh mock data:

```bash
cd actions/govbot
just mocks          # Default: refreshes wy and gu
just mocks il ny    # Refresh specific states
```

This clones real repos, prunes to 5 bills / 3 logs per session, and removes `.git` directories.

## Updating Expected Output

When govbot output changes (new fields, formatting changes):

```bash
cd actions/govbot

# Regenerate expected output files
govbot --help > tapes/expected/govbot-help.txt 2>&1
govbot clone --list > tapes/expected/govbot-clone-list.txt 2>&1
govbot logs --govbot-dir mocks/.govbot > tapes/expected/logs-basic.txt 2>&1

# Verify tapes still pass
TEST_MODE=mock just record
```

## CI Workflows

| Workflow | Trigger | What it does |
|----------|---------|--------------|
| `validate-snapshots.yml` | Push to main, PR | Rust unit tests + schema validation |
| `terminal-screenshots.yml` | PR (tape/src/Cargo changes) | VHS demo tapes in mock mode with snapshot assertions |
| `synthetic-test.yml` | Nightly + PR (tape/src changes) | Full E2E pipeline in prod and/or mock mode |

## Decision Tree: When to Add What Kind of Test

1. **Pure logic with no I/O?** → Rust unit test with insta (`tests/wizard_tests.rs`)
2. **CLI command with deterministic output?** → VHS demo tape with expected output file
3. **Full pipeline flow?** → Add to synthetic-test.tape
4. **Data format contract?** → JSON Schema in `actions/format/schemas/`
5. **New mock data needed?** → `just mocks <locale>`, then validate schemas pass
